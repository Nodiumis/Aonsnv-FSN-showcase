<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹´åº¦å›é¡¾ - å›¾ç‰‡ç‰ˆ</title>
    <style>
        :root {
            --primary-color: #00f2ff;
            --secondary-color: #bd00ff;
            --bg-color: #050505;
            --panel-bg: rgba(20, 20, 30, 0.9);
            --text-color: #ffffff;
            --font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            /* èƒŒæ™¯å›¾æ ·å¼ */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        canvas { display: block; width: 100%; height: 100%; }

        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 20px;
        }

        header { pointer-events: auto; text-align: left; text-shadow: 0 0 15px rgba(0, 242, 255, 0.6); }
        h1 { font-size: 3rem; font-weight: 800; background: linear-gradient(90deg, #fff, var(--primary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0; }

        /* é¡¶éƒ¨æŒ‰é’® */
        .top-tools {
            position: absolute; top: 20px; right: 20px;
            display: flex; gap: 10px; pointer-events: auto;
        }
        .btn-tool {
            background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff; padding: 8px 20px; border-radius: 25px; cursor: pointer; font-size: 0.9rem;
            backdrop-filter: blur(5px); transition: all 0.2s;
        }
        .btn-tool:hover { background: var(--primary-color); color: #000; border-color: var(--primary-color); }

        /* åº•éƒ¨æ§åˆ¶å™¨ */
        .controls {
            pointer-events: auto;
            position: absolute; bottom: 20px; left: 20px; width: 280px;
            background: var(--panel-bg); backdrop-filter: blur(15px);
            padding: 20px; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; font-size: 0.8rem; margin-bottom: 8px; color: var(--primary-color); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        button {
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;
        }
        button:hover { background: rgba(255,255,255,0.2); }
        button.active { background: var(--secondary-color); border-color: var(--secondary-color); color: #fff; }

        /* ç¼–è¾‘å¼¹çª— */
        .editor-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);
            z-index: 1000; display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .editor-modal.open { display: flex; opacity: 1; }

        .editor-content {
            background: #1a1a20; width: 90%; max-width: 700px; height: 85vh;
            border-radius: 20px; border: 1px solid var(--primary-color);
            box-shadow: 0 0 50px rgba(0, 242, 255, 0.15);
            display: flex; flex-direction: column; overflow: hidden;
        }

        .editor-header {
            padding: 20px 30px; border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center; background: #222;
        }
        .editor-header h2 { font-size: 1.4rem; color: #fff; }
        .close-btn { background: none; border: none; color: #aaa; font-size: 2rem; cursor: pointer; line-height: 1; }
        .close-btn:hover { color: #fff; }

        .editor-body { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        
        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
        .upload-section {
            background: #25252e; padding: 15px; border-radius: 10px; border: 1px dashed #555;
            display: flex; align-items: center; justify-content: space-between; gap: 15px;
        }
        .file-input-label { cursor: pointer; color: var(--primary-color); font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        .file-input-label:hover { text-decoration: underline; }
        
        textarea {
            width: 100%; height: 250px; background: #111; color: #ddd;
            border: 1px solid #444; border-radius: 8px; padding: 15px;
            font-family: 'Consolas', monospace; font-size: 13px; resize: vertical;
        }

        .editor-footer {
            padding: 20px 30px; border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: flex-end; gap: 15px; background: #222;
        }
        .btn-primary { background: var(--primary-color); color: #000; font-weight: bold; border: none; padding: 10px 25px; border-radius: 25px;}
        .btn-primary:hover { background: #fff; }
        .btn-export { background: var(--secondary-color); color: #fff; font-weight: bold; border: none; padding: 10px 25px; border-radius: 25px; }
        .btn-export:hover { background: #d440ff; }

        /* Toast */
        #toast-container { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; gap: 10px; pointer-events: none; z-index: 2000;}
        .toast { background: rgba(0, 0, 0, 0.9); border-left: 4px solid var(--primary-color); color: #fff; padding: 12px 24px; border-radius: 4px; font-size: 0.9rem; animation: slideUp 0.3s ease-out forwards; backdrop-filter: blur(4px); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 600px) {
            .controls { width: 100%; bottom: 0; left: 0; border-radius: 20px 20px 0 0; padding-bottom: 30px; }
            h1 { font-size: 2rem; margin-top: 10px; }
            .top-tools { top: 10px; right: 20px; }
            #toast-container { bottom: 280px; }
        }
    </style>
</head>
<body>

    <canvas id="canvas"></canvas>

    <div class="ui-layer">
        <header>
            <h1>MY 2024 REVIEW</h1>
        </header>

        <div class="top-tools">
            <button class="btn-tool" onclick="openEditor()">
                <span>ğŸ–¼ï¸</span> ç¼–è¾‘ & å¯¼å‡º
            </button>
        </div>

        <aside class="controls">
            <div class="control-group">
                <label>è¿åŠ¨æ¨¡å¼ Motion Mode</label>
                <div class="btn-grid">
                    <button onclick="setMode('orbit')" class="active" id="btn-orbit">æ ¸å¿ƒç¯ç»•</button>
                    <button onclick="setMode('helix')" id="btn-helix">æ—¶é—´èºæ—‹</button>
                    <button onclick="setMode('grid')" id="btn-grid">å…¨æ™¯ç½‘æ ¼</button>
                    <button onclick="setMode('random')" id="btn-random">è‡ªç”±æµ®åŠ¨</button>
                </div>
            </div>
            <div class="control-group">
                <label>çº¹ç†é£æ ¼ Texture</label>
                <div class="btn-grid">
                    <button onclick="setTexture('cyber')" class="active" id="btn-cyber">èµ›åšç½‘æ ¼</button>
                    <button onclick="setTexture('glass')" id="btn-glass">æå…‰ç»ç’ƒ</button>
                    <button onclick="setTexture('dot')" id="btn-dot">ç§‘æŠ€åœ†ç‚¹</button>
                </div>
            </div>
        </aside>
    </div>

    <!-- ç¼–è¾‘å¼¹çª— -->
    <div class="editor-modal" id="editorModal">
        <div class="editor-content">
            <div class="editor-header">
                <h2>é…ç½®ä¸­å¿ƒ</h2>
                <button class="close-btn" onclick="closeEditor()">Ã—</button>
            </div>
            <div class="editor-body">
                
                <!-- èƒŒæ™¯ä¸Šä¼  -->
                <div class="upload-section">
                    <div>
                        <strong style="color:#fff; display:block; margin-bottom:5px;">ğŸŒ èƒŒæ™¯å›¾ç‰‡</strong>
                        <span style="color:#888; font-size:12px;">ä¸Šä¼ å›¾ç‰‡ä½œä¸ºå…¨å±èƒŒæ™¯</span>
                    </div>
                    <input type="file" id="bgUpload" accept="image/*" style="display:none" onchange="handleBgUpload(this)">
                    <button onclick="document.getElementById('bgUpload').click()" style="background:#333; padding:5px 10px; border-radius:4px;">é€‰æ‹©å›¾ç‰‡</button>
                </div>

                <!-- å¡ç‰‡å›¾ç‰‡ä¸Šä¼  -->
                <div class="upload-section">
                    <div>
                        <strong style="color:#fff; display:block; margin-bottom:5px;">ğŸ‘¤ å¡ç‰‡å›¾ç‰‡ (å¤´åƒ)</strong>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="color:#888; font-size:12px;">åºå·(0-19):</span>
                            <input type="number" id="cardIndexInput" value="0" min="0" max="19" style="width:50px; padding:4px; background:#333; color:#fff; border:1px solid #555; border-radius:4px;">
                        </div>
                    </div>
                    <input type="file" id="cardUpload" accept="image/*" style="display:none" onchange="handleCardUpload(this)">
                    <button onclick="document.getElementById('cardUpload').click()" style="background:var(--primary-color); color:#000; font-weight:bold; padding:5px 10px; border-radius:4px; border:none;">ä¸Šä¼ å¤´åƒ</button>
                </div>

                <label style="color:#aaa; font-size:0.9rem; margin-top:10px;">ğŸ“ å¡ç‰‡æ•°æ® (JSONæ ¼å¼)ï¼š</label>
                <textarea id="jsonEditor" spellcheck="false"></textarea>
                <p style="color:#666; font-size:12px;">æç¤ºï¼šåœ¨ä¸Šä¼ å›¾ç‰‡åï¼Œæ­¤å¤„ä¼šè‡ªåŠ¨æ›´æ–°åŒ…å« Base64 ä»£ç ã€‚</p>
            </div>
            <div class="editor-footer">
                <button class="btn-export" onclick="exportHTML()">ğŸ“¥ å¯¼å‡º HTML</button>
                <button class="btn-primary" onclick="saveAndApply()">ğŸ’¾ ä¿å­˜å¹¶é¢„è§ˆ</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

<script>
// === æ•°æ®é…ç½®åŒºåŸŸ ===
// DATA_START
const cardData = [
    { title: "1æœˆ", progress: 0.4, color: "#ff0055", image: "" },
    { title: "2æœˆ", progress: 0.6, image: "" },
    { title: "3æœˆ", progress: 0.8, color: "#00ffaa", image: "" },
    { title: "4æœˆ", progress: 0.7, image: "" },
    { title: "5æœˆ", progress: 0.3, image: "" },
    { title: "6æœˆ", progress: 0.9, color: "#ffcc00", image: "" },
    { title: "7æœˆ", progress: 0.5, image: "" },
    { title: "8æœˆ", progress: 0.65, image: "" },
    { title: "9æœˆ", progress: 0.75, image: "" },
    { title: "10æœˆ", progress: 0.8, image: "" },
    { title: "11æœˆ", progress: 0.5, image: "" },
    { title: "12æœˆ", progress: 0.95, image: "" },
    { title: "Total Run", progress: 0.8, color: "#00f2ff", image: "" },
    { title: "Books Read", progress: 0.6, image: "" },
    { title: "Money Saved", progress: 0.9, image: "" },
    { title: "New Skill", progress: 0.85, image: "" },
    { title: "Team Work", progress: 0.7, image: "" },
    { title: "Best Moment", progress: 1.0, color: "#bd00ff", image: "" },
    { title: "Trip to JP", progress: 0.8, image: "" },
    { title: "Family Time", progress: 1.0, color: "#ff9900", image: "" }
];
// DATA_END

// å…¨å±€å˜é‡
let customBgImage = ""; // å­˜å‚¨èƒŒæ™¯å›¾çš„Base64
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let config = {
    cardCount: cardData.length,
    baseSpeed: 0.8,
    mode: 'orbit', 
    textureType: 'cyber',
    focalLength: 800,
    cx: window.innerWidth / 2,
    cy: window.innerHeight / 2
};

const textures = { cyber: null, glass: null, dot: null };

// é»˜è®¤å¤´åƒï¼ˆå½“æ²¡æœ‰ä¸Šä¼ å›¾ç‰‡æ—¶ä½¿ç”¨ï¼‰
const defaultAvatarCanvas = document.createElement('canvas');
defaultAvatarCanvas.width = 100; defaultAvatarCanvas.height = 100;
const dCtx = defaultAvatarCanvas.getContext('2d');
// ç”»ä¸€ä¸ªæ¸å˜åœ†ä½œä¸ºé»˜è®¤å¤´åƒ
const dGrad = dCtx.createLinearGradient(0,0,100,100);
dGrad.addColorStop(0, '#333'); dGrad.addColorStop(1, '#555');
dCtx.fillStyle = dGrad; dCtx.beginPath(); dCtx.arc(50,50,50,0,Math.PI*2); dCtx.fill();
dCtx.fillStyle = '#888'; dCtx.font = '12px Arial'; dCtx.textAlign='center'; dCtx.fillText("NO IMAGE", 50, 55);
const defaultAvatarUrl = defaultAvatarCanvas.toDataURL();

class Card {
    constructor(index, data) {
        this.index = index;
        this.data = data;
        this.width = 160;
        this.height = 220; // ç¨å¾®çŸ®ä¸€ç‚¹ï¼Œé€‚åº”å¤´åƒå¸ƒå±€
        
        this.x = 0; this.y = 0; this.z = 0;
        this.targetX = 0; this.targetY = 0; this.targetZ = 0;
        this.rotX = 0; this.rotY = 0;
        this.targetRotX = 0; this.targetRotY = 0;
        
        if (data.color) {
            this.colorHue = null; 
            this.fixedColor = data.color;
        } else {
            this.colorHue = Math.random() * 60 + 160; 
        }

        // å›¾ç‰‡å¯¹è±¡
        this.img = new Image();
        this.updateImage(data.image);
        
        // åˆå§‹ä½ç½®
        this.x = (Math.random() - 0.5) * 2000;
        this.y = (Math.random() - 0.5) * 2000;
        this.z = (Math.random() - 0.5) * 2000;
    }

    updateImage(base64Str) {
        if (base64Str && base64Str.length > 10) {
            this.img.src = base64Str;
        } else {
            this.img.src = defaultAvatarUrl;
        }
    }

    update(time) {
        this.calculateTarget(time);
        const ease = 0.05 * config.baseSpeed;
        
        this.x += (this.targetX - this.x) * ease;
        this.y += (this.targetY - this.y) * ease;
        this.z += (this.targetZ - this.z) * ease;
        this.rotX += (this.targetRotX - this.rotX) * ease;
        this.rotY += (this.targetRotY - this.rotY) * ease;
    }

    calculateTarget(time) {
        const i = this.index;
        if (config.mode === 'orbit') {
            const radius = 350 + (i % 3) * 80;
            const speed = time * 0.5 * config.baseSpeed + (i * 0.2);
            if (i === 0) { 
                this.targetX = 0; this.targetY = 0; this.targetZ = 250;
                this.targetRotY = speed * 0.5;
                this.targetRotX = Math.sin(time * 0.2) * 0.1;
            } else {
                this.targetX = Math.cos(speed) * radius;
                this.targetY = Math.sin(speed) * radius * 0.5;
                this.targetZ = Math.sin(speed) * radius;
                this.targetRotY = speed + Math.PI / 2;
                this.targetRotX = 0.2;
            }
        } 
        else if (config.mode === 'helix') {
            const spacing = 70;
            const totalHeight = (config.cardCount * spacing) / 2;
            const yOffset = (i * spacing) - totalHeight;
            this.targetY = yOffset;
            this.targetX = Math.sin(time * config.baseSpeed + i * 0.3) * 280;
            this.targetZ = Math.cos(time * config.baseSpeed + i * 0.3) * 280 - 200;
            this.targetRotY = time * config.baseSpeed + i;
            this.targetRotX = 0.5;
        }
        else if (config.mode === 'grid') {
            const cols = 5;
            const col = i % cols;
            const row = Math.floor(i / cols);
            const gap = 180;
            this.targetX = (col - 2) * gap;
            this.targetY = (row - 2) * gap;
            this.targetZ = 0;
            this.targetRotX = 0; this.targetRotY = 0;
        }
        else if (config.mode === 'random') {
            if (Math.abs(this.targetX - this.x) < 10) {
                this.targetX = (Math.random() - 0.5) * 1000;
                this.targetY = (Math.random() - 0.5) * 600;
                this.targetZ = (Math.random() - 0.5) * 800;
            }
            this.targetRotX += 0.01; this.targetRotY += 0.02;
        }
    }

    draw(ctx) {
        const scale = config.focalLength / (config.focalLength + this.z);
        const screenX = config.cx + this.x * scale;
        const screenY = config.cy + this.y * scale;
        
        if (scale < 0) return;

        const w = this.width * scale;
        const h = this.height * scale;

        ctx.save();
        ctx.translate(screenX, screenY);
        ctx.scale(scale, scale); 
        ctx.rotate(this.rotX * 0.5); 

        let mainColor = this.fixedColor || `hsla(${this.colorHue}, 80%, 60%, 1)`;
        let glowColor = this.fixedColor || `hsla(${this.colorHue}, 80%, 60%, 0.5)`;

        ctx.shadowBlur = 25 * scale;
        ctx.shadowColor = glowColor;

        let pattern = textures[config.textureType];
        
        // 1. ç»˜åˆ¶å¡ç‰‡èƒŒæ™¯
        ctx.beginPath();
        ctx.roundRect(-this.width/2, -this.height/2, this.width, this.height, 20);
        ctx.fillStyle = pattern || '#222';
        ctx.fill();
        
        // è¾¹æ¡†
        ctx.lineWidth = 2;
        ctx.strokeStyle = mainColor;
        ctx.stroke();

        // 2. ç»˜åˆ¶åœ†å½¢å¤´åƒ (QQå¤´åƒé£æ ¼)
        const avatarRadius = 50; // åŠå¾„
        ctx.save();
        ctx.beginPath();
        ctx.arc(0, -35, avatarRadius, 0, Math.PI * 2);
        ctx.clip(); // è£å‰ªåŒºåŸŸ
        
        // ç»˜åˆ¶å›¾ç‰‡
        try {
            ctx.drawImage(this.img, -avatarRadius, -35 - avatarRadius, avatarRadius*2, avatarRadius*2);
        } catch(e) {
            // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥
            ctx.fillStyle = '#333';
            ctx.fill();
        }
        ctx.restore();

        // å¤´åƒå¤–åœˆæè¾¹
        ctx.beginPath();
        ctx.arc(0, -35, avatarRadius, 0, Math.PI * 2);
        ctx.lineWidth = 3;
        ctx.strokeStyle = '#fff';
        ctx.stroke();

        // 3. ç»˜åˆ¶æ ‡é¢˜ (æ— å‰¯æ ‡é¢˜)
        ctx.shadowBlur = 0;
        ctx.textAlign = 'center';
        ctx.fillStyle = '#fff';
        
        let displayTitle = this.data.title;
        if (displayTitle.length > 8) displayTitle = displayTitle.substring(0, 8) + '..';
        ctx.font = 'bold 18px "Segoe UI", sans-serif';
        ctx.fillText(displayTitle, 0, 35);
        
        // 4. ç»˜åˆ¶è¿›åº¦æ¡
        const barWidth = 100;
        let pVal = parseFloat(this.data.progress);
        if(isNaN(pVal)) pVal = 0;
        if(pVal > 1) pVal = 1;
        if(pVal < 0) pVal = 0;

        ctx.fillStyle = 'rgba(255,255,255,0.2)';
        ctx.fillRect(-barWidth/2, 70, barWidth, 6);
        ctx.fillStyle = mainColor;
        ctx.fillRect(-barWidth/2, 70, barWidth * pVal, 6);
        
        // æ•°å€¼
        ctx.fillStyle = mainColor;
        ctx.font = 'bold 12px monospace';
        ctx.fillText(Math.round(pVal * 100) + '%', 0, 90);

        ctx.restore();
    }
}

const cards = [];

function init() {
    resize();
    createTextures();
    cards.length = 0;
    config.cardCount = cardData.length;
    for(let i = 0; i < cardData.length; i++) {
        cards.push(new Card(i, cardData[i]));
    }
    
    // åº”ç”¨ä¿å­˜çš„èƒŒæ™¯
    if(customBgImage) {
        document.body.style.backgroundImage = `url(${customBgImage})`;
    }
}

function createTextures() {
    const cCanvas = document.createElement('canvas'); cCanvas.width = 100; cCanvas.height = 100;
    const cCtx = cCanvas.getContext('2d');
    cCtx.fillStyle = '#1a1a24'; cCtx.fillRect(0,0,100,100);
    cCtx.strokeStyle = 'rgba(0, 242, 255, 0.15)'; cCtx.lineWidth = 1;
    cCtx.beginPath(); cCtx.moveTo(0,0); cCtx.lineTo(100,100); cCtx.stroke();
    cCtx.strokeRect(0,0,100,100);
    textures.cyber = ctx.createPattern(cCanvas, 'repeat');

    const gCanvas = document.createElement('canvas'); gCanvas.width = 200; gCanvas.height = 200;
    const gCtx = gCanvas.getContext('2d');
    const grad = gCtx.createLinearGradient(0,0,200,200);
    grad.addColorStop(0, '#2b0036'); grad.addColorStop(1, '#001a24');
    gCtx.fillStyle = grad; gCtx.fillRect(0,0,200,200);
    textures.glass = ctx.createPattern(gCanvas, 'repeat');

    const dCanvas = document.createElement('canvas'); dCanvas.width = 20; dCanvas.height = 20;
    const dCtx = dCanvas.getContext('2d');
    dCtx.fillStyle = '#111'; dCtx.fillRect(0,0,20,20);
    dCtx.fillStyle = 'rgba(255,255,255,0.1)';
    dCtx.beginPath(); dCtx.arc(10,10,2,0,Math.PI*2); dCtx.fill();
    textures.dot = ctx.createPattern(dCanvas, 'repeat');
}

let time = 0;
function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    time += 0.01 * config.baseSpeed;
    cards.sort((a, b) => b.z - a.z);
    cards.forEach(card => {
        card.update(time);
        card.draw(ctx);
    });
    requestAnimationFrame(animate);
}

// ================= äº¤äº’é€»è¾‘ =================

function setMode(mode) {
    config.mode = mode;
    document.querySelectorAll('.btn-grid button').forEach(b => {
        if(b.id === `btn-${mode}`) b.classList.add('active');
        else if(b.id.startsWith('btn-') && 
!['btn-cyber','btn-glass','btn-dot'].includes(b.id)
) b.classList.remove('active');
    });
}

function setTexture(type) {
    config.textureType = type;
    document.querySelectorAll('.btn-grid button').forEach(b => {
        if(b.id === `btn-${type}`) b.classList.add('active');
        else if(b.id.startsWith('btn-') && 
['btn-cyber','btn-glass','btn-dot'].includes(b.id)
) b.classList.remove('active');
    });
}

function resize() {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    config.cx = canvas.width / 2; config.cy = canvas.height / 2;
    config.focalLength = window.innerWidth < 600 ? 500 : 800;
}
window.addEventListener('resize', resize);

// ================= ç¼–è¾‘å™¨é€»è¾‘ =================

const editorModal = document.getElementById('editorModal');
const jsonEditor = document.getElementById('jsonEditor');

function openEditor() {
    jsonEditor.value = JSON.stringify(cardData, null, 4);
    editorModal.classList.add('open');
}

function closeEditor() {
    editorModal.classList.remove('open');
}

// å¤„ç†èƒŒæ™¯ä¸Šä¼ 
function handleBgUpload(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            customBgImage = e.target.result;
            document.body.style.backgroundImage = `url(${customBgImage})`;
            showToast("èƒŒæ™¯å›¾ç‰‡å·²åŠ è½½");
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// å¤„ç†å¡ç‰‡å›¾ç‰‡ä¸Šä¼ 
function handleCardUpload(input) {
    const index = parseInt(document.getElementById('cardIndexInput').value);
    if (isNaN(index) || index < 0 || index >= cardData.length) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å¡ç‰‡åºå· (0-" + (cardData.length-1) + ")");
        return;
    }

    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const base64 = e.target.result;
            // æ›´æ–°å†…å­˜ä¸­çš„æ•°æ®
            cardData[index].image = base64;
            // æ›´æ–°ç¼–è¾‘å™¨æ–‡æœ¬åŸŸï¼Œè®©ç”¨æˆ·çœ‹åˆ°å˜åŒ–
            jsonEditor.value = JSON.stringify(cardData, null, 4);
            // å®æ—¶æ›´æ–°å¡ç‰‡æ˜¾ç¤º
            if(cards[index]) cards[index].updateImage(base64);
            showToast(`å¡ç‰‡ #${index} å›¾ç‰‡å·²æ›´æ–°`);
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function saveAndApply() {
    try {
        const newData = JSON.parse(jsonEditor.value);
        if (!Array.isArray(newData)) throw new Error("æ•°æ®å¿…é¡»æ˜¯æ•°ç»„æ ¼å¼");
        
        cardData.length = 0;
        newData.forEach(item => cardData.push(item));
        
        init();
        closeEditor();
        showToast("è®¾ç½®å·²ä¿å­˜å¹¶åº”ç”¨ï¼");
    } catch (e) {
        alert("JSON æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥ï¼\n" + e.message);
    }
}

// ================= å¯¼å‡ºé€»è¾‘ =================

function exportHTML() {
    // 1. å‡†å¤‡æ•°æ®å­—ç¬¦ä¸²
    const newDataString = JSON.stringify(cardData, null, 4);
    
    // 2. è·å–å½“å‰ HTML
    let htmlContent = document.documentElement.outerHTML;

    // 3. æ›¿æ¢æ•°æ®éƒ¨åˆ†
    const startTag = "// DATA_START";
    const endTag = "// DATA_END";
    const regex = new RegExp(`${startTag}[\\s\\S]*?${endTag}`);
    const replacement = `${startTag}\nconst cardData = ${newDataString};\n${endTag}`;
    htmlContent = htmlContent.replace(regex, replacement);

    // 4. æ³¨å…¥èƒŒæ™¯å›¾
    // æŸ¥æ‰¾ let customBgImage = ""; å¹¶æ›¿æ¢
    // æ³¨æ„ï¼šæˆ‘ä»¬éœ€è¦è½¬ä¹‰å•å¼•å·æˆ–åŒå¼•å·ï¼Œè¿™é‡Œä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²çš„åŸå§‹å½¢å¼
    const bgScriptInjection = `let customBgImage = ${customBgImage ? `"${customBgImage}"` : '""'};`;
    
    // ä½¿ç”¨æ­£åˆ™æ‰¾åˆ°é‚£è¡Œå¹¶æ›¿æ¢
    const bgRegex = /let customBgImage = "";/;
    htmlContent = htmlContent.replace(bgRegex, bgScriptInjection);

    // 5. ç¡®ä¿å¼¹çª—å…³é—­
    htmlContent = htmlContent.replace(/class="editor-modal open"/g, 'class="editor-modal"');

    // 6. ä¸‹è½½
    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'my-annual-review-img.html';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast("HTML æ–‡ä»¶å·²å¯¼å‡ºï¼(åŒ…å«å›¾ç‰‡)");
}

function showToast(msg) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast'; toast.textContent = msg;
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.opacity = '0'; toast.style.transform = 'translateY(-20px)';
        toast.addEventListener('transitionend', () => toast.remove());
    }, 3000);
}

// å¯åŠ¨
init();
animate();
</script>
</body>
</html>
