<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG å¯¹è¯ç¼–è¾‘å™¨ - ç»ˆæè‡ªå®šä¹‰ç‰ˆ</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --panel-bg: #1e293b;
            --accent-color: #6366f1;
            --text-color: #f1f5f9;
            --border-color: #334155;
            --danger-color: #ef4444;
            --success-color: #10b981;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        header {
            height: 60px;
            background-color: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        h1 { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px; color: var(--accent-color); }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary { background-color: var(--accent-color); color: white; box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.3); }
        .btn-primary:hover { background-color: #4f46e5; transform: translateY(-1px); }
        .btn-primary:active { transform: translateY(0); }
        
        .btn-success { background-color: var(--success-color); color: white; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3); }
        .btn-success:hover { background-color: #059669; transform: translateY(-1px); }

        /* ä¸»å¸ƒå±€ */
        main {
            display: flex;
            flex: 1;
            height: calc(100vh - 60px);
            overflow: hidden;
        }

        /* å·¦ä¾§ï¼šç¼–è¾‘å™¨é¢æ¿ */
        .editor-pane {
            width: 420px;
            background-color: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
            padding: 20px;
            gap: 20px;
        }

        /* è§’è‰²å¡ç‰‡è®¾è®¡ */
        .char-card {
            background-color: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .char-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .char-header span {
            font-weight: 600;
            color: var(--accent-color);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }

        /* å¤´åƒä¸Šä¼ åŒºåŸŸ */
        .avatar-upload-container {
            position: relative;
            width: 100px;
            height: 100px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .avatar-upload-container:hover { transform: scale(1.05); }

        .avatar-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: 3px solid var(--border-color);
            transition: all 0.3s;
        }

        .upload-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            color: white;
            font-size: 0.8rem;
            text-align: center;
            padding: 5px;
            pointer-events: none;
        }

        .avatar-upload-container:hover .upload-overlay { opacity: 1; }

        .file-input { display: none; }

        /* è§’è‰²åå­—è¾“å…¥ */
        .name-input {
            width: 100%;
            padding: 8px 12px;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: white;
            text-align: center;
            font-weight: 600;
        }
        .name-input:focus { border-color: var(--accent-color); }

        /* æ ·å¼è®¾ç½®ç½‘æ ¼ */
        .style-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
        }

        .style-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .style-item label {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        select, input[type="color"] {
            width: 100%;
            padding: 6px;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }

        input[type="color"] { height: 35px; padding: 0; border: none; }

        /* å¯¹è¯å‰§æœ¬åŒºåŸŸ */
        .script-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .script-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .script-header span {
            font-size: 0.9rem;
            font-weight: 600;
            color: #94a3b8;
        }

        .dialogue-list {
            max-height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-right: 5px;
        }

        .dialogue-line {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: border-color 0.2s;
        }

        .dialogue-line:hover { border-color: var(--accent-color); }

        .line-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .speaker-select {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            font-size: 0.8rem;
            opacity: 0.7;
        }
        .delete-btn:hover { opacity: 1; text-decoration: underline; }

        .text-area {
            width: 100%;
            background: transparent;
            border: none;
            color: white;
            font-family: inherit;
            resize: vertical;
            min-height: 40px;
        }
        .text-area::placeholder { color: rgba(255,255,255,0.2); }

        .add-btn {
            width: 100%;
            padding: 10px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px dashed var(--accent-color);
            color: var(--accent-color);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .add-btn:hover { background: rgba(99, 102, 241, 0.2); }

        /* å³ä¾§é¢„è§ˆåŒº */
        .preview-pane {
            flex: 1;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 20px;
        }

        .game-window {
            width: 800px;
            height: 600px;
            background: #222;
            border: 8px solid #444;
            border-radius: 8px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* æ¸¸æˆå†…æ ·å¼ */
        .game-scene {
            flex: 1;
            background-size: cover;
            background-position: center;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding-bottom: 40px;
            transition: background-image 0.5s ease;
        }

        .game-avatar {
            width: 200px;
            height: 350px;
            background-size: cover;
            background-position: top center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            /* é»˜è®¤é˜´å½± */
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));
        }

        .avatar-left { margin-left: 60px; transform: scale(0.9) translateY(20px); opacity: 0.7; filter: brightness(0.6) grayscale(0.3); }
        .avatar-right { margin-right: 60px; transform: scale(1) translateY(0); opacity: 1; filter: brightness(1.1); }

        /* æ¿€æ´»çŠ¶æ€ */
        .scene-left-active .avatar-left { transform: scale(1.1) translateY(-20px); opacity: 1; filter: brightness(1.2) drop-shadow(0 0 20px rgba(255,255,255,0.2)); z-index: 2; }
        .scene-left-active .avatar-right { transform: scale(0.9) translateY(20px); opacity: 0.5; filter: grayscale(0.8); z-index: 1; }
        
        .scene-right-active .avatar-right { transform: scale(1.1) translateY(-20px); opacity: 1; filter: brightness(1.2) drop-shadow(0 0 20px rgba(255,255,255,0.2)); z-index: 2; }
        .scene-right-active .avatar-left { transform: scale(0.9) translateY(20px); opacity: 0.5; filter: grayscale(0.8); z-index: 1; }

        /* å¤´åƒå½¢çŠ¶åº”ç”¨ */
        .shape-circle { border-radius: 50%; }
        .shape-rounded { border-radius: 20px; }
        .shape-square { border-radius: 0; }
        
        /* å¤´åƒè¾¹æ¡†åº”ç”¨ */
        .border-none { border: none; }
        .border-solid { border: 4px solid var(--avatar-border-color, white); }
        .border-glow { box-shadow: 0 0 20px var(--avatar-border-color, white); border: 2px solid var(--avatar-border-color, white); }

        .game-dialogue {
            height: 180px;
            background: rgba(0, 0, 0, 0.85);
            border: 3px solid white;
            border-radius: 12px;
            margin: 20px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            position: relative;
            backdrop-filter: blur(10px);
        }

        .game-name {
            position: absolute;
            top: -18px;
            left: 30px;
            padding: 6px 24px;
            background: var(--dialogue-color, #333);
            border: 3px solid white;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.3rem;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .game-text {
            margin-top: 10px;
            font-size: 1.2rem;
            line-height: 1.6;
            color: white;
            white-space: pre-wrap;
        }

        .game-next {
            position: absolute;
            bottom: 15px;
            right: 20px;
            animation: bounce 1s infinite;
            cursor: pointer;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(5px); }
        }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Toast */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: translateX(200%);
            transition: transform 0.3s ease-out;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .toast.show { transform: translateX(0); }

        @media (max-width: 1200px) {
            .game-window { width: 100%; height: 100%; border: none; border-radius: 0; }
        }
    </style>
</head>
<body>

<header>
    <h1>ğŸ® RPG å¯¹è¯ç¼–è¾‘å™¨</h1>
    <div style="display: flex; gap: 10px;">
        <button class="btn btn-primary" onclick="resetAll()">é‡ç½®</button>
        <button class="btn btn-success" onclick="exportGame()">ğŸ“¤ å¯¼å‡ºæ¸¸æˆ</button>
    </div>
</header>

<main>
    <!-- å·¦ä¾§ç¼–è¾‘å™¨ -->
    <div class="editor-pane">
        
        <!-- ç©å®¶å¡ç‰‡ -->
        <div class="char-card" id="player-card">
            <div class="char-header">
                <span>ç©å®¶è®¾å®š</span>
            </div>
            
            <div class="avatar-upload-container" onclick="document.getElementById('player-file').click()">
                <img src="" id="player-thumb" class="avatar-preview">
                <div class="upload-overlay">ç‚¹å‡»ä¸Šä¼ </div>
                <input type="file" id="player-file" class="file-input" accept="image/*" onchange="handleUpload(this, 'player')">
            </div>

            <input type="text" class="name-input" id="player-name" placeholder="è¾“å…¥åå­—" oninput="updateName('player')">

            <div class="style-grid">
                <div class="style-item">
                    <label>å¤´åƒå½¢çŠ¶</label>
                    <select id="player-shape" onchange="updateStyle('player')">
                        <option value="circle">åœ†å½¢</option>
                        <option value="rounded">åœ†è§’</option>
                        <option value="square">æ–¹å½¢</option>
                    </select>
                </div>
                <div class="style-item">
                    <label>è¾¹æ¡†æ ·å¼</label>
                    <select id="player-border-style" onchange="updateStyle('player')">
                        <option value="none">æ— </option>
                        <option value="solid">å®çº¿</option>
                        <option value="glow">å‘å…‰</option>
                    </select>
                </div>
                <div class="style-item">
                    <label>è¾¹æ¡†/åå­—é¢œè‰²</label>
                    <input type="color" id="player-color" value="#3b82f6" oninput="updateStyle('player')">
                </div>
            </div>
        </div>

        <!-- BOSS å¡ç‰‡ -->
        <div class="char-card" id="boss-card">
            <div class="char-header">
                <span>BOSS è®¾å®š</span>
            </div>
            
            <div class="avatar-upload-container" onclick="document.getElementById('boss-file').click()">
                <img src="" id="boss-thumb" class="avatar-preview">
                <div class="upload-overlay">ç‚¹å‡»ä¸Šä¼ </div>
                <input type="file" id="boss-file" class="file-input" accept="image/*" onchange="handleUpload(this, 'boss')">
            </div>

            <input type="text" class="name-input" id="boss-name" placeholder="è¾“å…¥åå­—" oninput="updateName('boss')">

            <div class="style-grid">
                <div class="style-item">
                    <label>å¤´åƒå½¢çŠ¶</label>
                    <select id="boss-shape" onchange="updateStyle('boss')">
                        <option value="circle">åœ†å½¢</option>
                        <option value="rounded">åœ†è§’</option>
                        <option value="square">æ–¹å½¢</option>
                    </select>
                </div>
                <div class="style-item">
                    <label>è¾¹æ¡†æ ·å¼</label>
                    <select id="boss-border-style" onchange="updateStyle('boss')">
                        <option value="none">æ— </option>
                        <option value="solid">å®çº¿</option>
                        <option value="glow">å‘å…‰</option>
                    </select>
                </div>
                <div class="style-item">
                    <label>è¾¹æ¡†/åå­—é¢œè‰²</label>
                    <input type="color" id="boss-color" value="#ef4444" oninput="updateStyle('boss')">
                </div>
            </div>
        </div>

        <!-- èƒŒæ™¯è®¾ç½® -->
        <div class="char-card" style="align-items: stretch;">
            <div class="char-header">
                <span>åœºæ™¯èƒŒæ™¯</span>
            </div>
            <div class="style-grid">
                <div class="style-item" style="grid-column: span 2;">
                    <label>ä¸Šä¼ èƒŒæ™¯å›¾</label>
                    <div style="position: relative; height: 60px; border: 2px dashed var(--border-color); border-radius: 6px; overflow: hidden; cursor: pointer; background: rgba(0,0,0,0.2);" onclick="document.getElementById('bg-file').click()">
                        <img id="bg-thumb" src="" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.7;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.8rem; color: white;">ç‚¹å‡»ä¸Šä¼ </div>
                        <input type="file" id="bg-file" class="file-input" accept="image/*" onchange="handleUpload(this, 'bg')">
                    </div>
                </div>
            </div>
        </div>

        <!-- å‰§æœ¬ç¼–è¾‘ -->
        <div class="script-section">
            <div class="script-header">
                <span>å‰§æœ¬å¯¹è¯</span>
            </div>
            <div class="dialogue-list" id="dialogue-list">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button class="add-btn" onclick="addDialogue()">+ æ·»åŠ å¯¹è¯</button>
        </div>

    </div>

    <!-- å³ä¾§é¢„è§ˆ -->
    <div class="preview-pane">
        <div class="game-window" onclick="nextDialogue()">
            <div class="game-scene" id="game-scene">
                <div class="game-avatar avatar-left" id="game-avatar-left"></div>
                <div class="game-avatar avatar-right" id="game-avatar-right"></div>
            </div>
            <div class="game-dialogue">
                <div class="game-name" id="game-name">???</div>
                <div class="game-text" id="game-text">ç‚¹å‡»å±å¹•å¼€å§‹æ¸¸æˆ</div>
                <div class="game-next">â–¼</div>
            </div>
        </div>
    </div>
</main>

<div class="toast" id="toast">
    <span>âœ…</span>
    <span id="toast-msg">æ¸¸æˆå·²å¯¼å‡ºï¼</span>
</div>

<script>
    // é»˜è®¤æ•°æ®
    const defaultData = {
        player: {
            name: "å‹‡è€…",
            img: "https://picsum.photos/seed/hero/200/200",
            shape: "circle",
            borderStyle: "solid",
            color: "#3b82f6"
        },
        boss: {
            name: "é­”ç‹",
            img: "https://picsum.photos/seed/villain/200/200",
            shape: "circle",
            borderStyle: "solid",
            color: "#ef4444"
        },
        bg: "https://picsum.photos/seed/bg/800/600",
        script: [
            { speaker: "boss", text: "å“¼ï¼Œä½ ç»ˆäºæ¥äº†ï¼Œä¸è‡ªé‡åŠ›çš„å‹‡è€…ã€‚" },
            { speaker: "player", text: "æŠŠå…¬ä¸»è¿˜ç»™æˆ‘ï¼å¦åˆ™æˆ‘å°±è¦åŠ¨ç²—äº†ï¼" },
            { speaker: "boss", text: "åŠ¨ç²—ï¼Ÿå“ˆå“ˆå“ˆå“ˆï¼åœ¨è¿™ä¸ªä¸–ç•Œï¼Œåªæœ‰åŠ›é‡æ‰æ˜¯çœŸç†ï¼" },
            { speaker: "player", text: "æ­£ä¹‰ç»ˆå°†æˆ˜èƒœé‚ªæ¶ï¼æ¥æ‹›å§ï¼" }
        ]
    };

    let data = JSON.parse(JSON.stringify(defaultData));
    let currentLine = -1;
    let isTyping = false;

    // åˆå§‹åŒ–
    function init() {
        loadUI();
        renderScript();
        updatePreview();
    }

    // --- UI åŠ è½½ä¸æ›´æ–° ---

    function loadUI() {
        // Player
        document.getElementById('player-name').value = data.player.name;
        document.getElementById('player-thumb').src = data.player.img;
        document.getElementById('player-shape').value = data.player.shape;
        document.getElementById('player-border-style').value = data.player.borderStyle;
        document.getElementById('player-color').value = data.player.color;

        // Boss
        document.getElementById('boss-name').value = data.boss.name;
        document.getElementById('boss-thumb').src = data.boss.img;
        document.getElementById('boss-shape').value = data.boss.shape;
        document.getElementById('boss-border-style').value = data.boss.borderStyle;
        document.getElementById('boss-color').value = data.boss.color;

        // BG
        document.getElementById('bg-thumb').src = data.bg;
    }

    function updateName(role) {
        if (role === 'player') data.player.name = document.getElementById('player-name').value;
        if (role === 'boss') data.boss.name = document.getElementById('boss-name').value;
        updatePreviewStatic();
    }

    function updateStyle(role) {
        if (role === 'player') {
            data.player.shape = document.getElementById('player-shape').value;
            data.player.borderStyle = document.getElementById('player-border-style').value;
            data.player.color = document.getElementById('player-color').value;
            // æ›´æ–°å·¦ä¾§ç¼©ç•¥å›¾æ ·å¼
            const thumb = document.getElementById('player-thumb');
            applyShapeStyle(thumb, data.player);
        } else {
            data.boss.shape = document.getElementById('boss-shape').value;
            data.boss.borderStyle = document.getElementById('boss-border-style').value;
            data.boss.color = document.getElementById('boss-color').value;
            const thumb = document.getElementById('boss-thumb');
            applyShapeStyle(thumb, data.boss);
        }
        updatePreviewStatic();
    }

    function applyShapeStyle(el, config) {
        // é‡ç½®
        el.className = 'avatar-preview'; 
        el.style.border = 'none';
        el.style.boxShadow = 'none';
        
        // å½¢çŠ¶
        if (config.shape === 'circle') el.style.borderRadius = '50%';
        if (config.shape === 'rounded') el.style.borderRadius = '16px';
        if (config.shape === 'square') el.style.borderRadius = '0';

        // è¾¹æ¡† (ç¼©ç•¥å›¾ç”¨ç®€åŒ–æ ·å¼ï¼Œå®é™…æ¸¸æˆç”¨æ›´å¤æ‚çš„)
        if (config.borderStyle === 'solid') el.style.border = `3px solid ${config.color}`;
        if (config.borderStyle === 'glow') el.style.boxShadow = `0 0 10px ${config.color}`;
    }

    function handleUpload(input, type) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const base64 = e.target.result;
            if (type === 'player') {
                data.player.img = base64;
                document.getElementById('player-thumb').src = base64;
            } else if (type === 'boss') {
                data.boss.img = base64;
                document.getElementById('boss-thumb').src = base64;
            } else if (type === 'bg') {
                data.bg = base64;
                document.getElementById('bg-thumb').src = base64;
            }
            updatePreviewStatic();
        };
        reader.readAsDataURL(file);
    }

    // --- å‰§æœ¬ç®¡ç† ---

    function renderScript() {
        const list = document.getElementById('dialogue-list');
        list.innerHTML = '';
        
        data.script.forEach((line, idx) => {
            const div = document.createElement('div');
            div.className = 'dialogue-line';
            
            const isPlayer = line.speaker === 'player';
            const name = isPlayer ? data.player.name : data.boss.name;
            const color = isPlayer ? data.player.color : data.boss.color;

            div.innerHTML = `
                <div class="line-controls">
                    <select class="speaker-select" onchange="changeSpeaker(${idx}, this.value)" style="border-color:${color}">
                        <option value="player" ${isPlayer ? 'selected' : ''}>ğŸ‘¤ ç©å®¶</option>
                        <option value="boss" ${!isPlayer ? 'selected' : ''}>ğŸ‘¿ BOSS</option>
                    </select>
                    <button class="delete-btn" onclick="deleteLine(${idx})">åˆ é™¤</button>
                </div>
                <textarea class="text-area" placeholder="è¾“å…¥å¯¹è¯å†…å®¹..." oninput="updateText(${idx}, this.value)">${line.text}</textarea>
            `;
            list.appendChild(div);
        });
    }

    function addDialogue() {
        data.script.push({ speaker: 'player', text: 'æ–°å¯¹è¯...' });
        renderScript();
    }

    window.changeSpeaker = function(idx, val) {
        data.script[idx].speaker = val;
        renderScript(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é¢œè‰²
    };

    window.updateText = function(idx, val) {
        data.script[idx].text = val;
    };

    window.deleteLine = function(idx) {
        data.script.splice(idx, 1);
        renderScript();
        resetPreview();
    };

    // --- é¢„è§ˆé€»è¾‘ ---

    function updatePreviewStatic() {
        // æ›´æ–°å¤´åƒå’Œåå­—
        const leftAv = document.getElementById('game-avatar-left');
        const rightAv = document.getElementById('game-avatar-right');
        const nameTag = document.getElementById('game-name');

        leftAv.style.backgroundImage = `url('${data.player.img}')`;
        rightAv.style.backgroundImage = `url('${data.boss.img}')`;

        // åº”ç”¨å½¢çŠ¶å’Œè¾¹æ¡†
        applyGameAvatarStyle(leftAv, data.player);
        applyGameAvatarStyle(rightAv, data.boss);

        // å¦‚æœå½“å‰æ­£åœ¨æ˜¾ç¤ºå¯¹è¯ï¼Œæ›´æ–°åå­—æ ‡ç­¾é¢œè‰²
        if (currentLine >= 0) {
            const line = data.script[currentLine];
            const config = line.speaker === 'player' ? data.player : data.boss;
            nameTag.style.background = config.color;
        }
    }

    function applyGameAvatarStyle(el, config) {
        el.className = `game-avatar`; // reset
        // å½¢çŠ¶
        if (config.shape === 'circle') el.style.borderRadius = '50%';
        if (config.shape === 'rounded') el.style.borderRadius = '30px';
        if (config.shape === 'square') el.style.borderRadius = '0';
        
        // è¾¹æ¡†/å…‰æ•ˆ (åˆ©ç”¨CSSå˜é‡æˆ–ç›´æ¥style)
        el.style.removeProperty('--avatar-border-color'); // æ¸…ç†å˜é‡
        el.style.boxShadow = 'none';
        el.style.border = 'none';

        if (config.borderStyle === 'solid') {
            el.style.border = `6px solid ${config.color}`;
            // ä¸ºäº†è®©å®çº¿è¾¹æ¡†åœ¨åœ†å½¢å¤´åƒä¸Šå¥½çœ‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦é¢å¤–å¤„ç†
        }
        if (config.borderStyle === 'glow') {
            el.style.boxShadow = `0 0 30px ${config.color}`;
            el.style.border = `2px solid ${config.color}`;
        }
    }

    function updatePreview() {
        updatePreviewStatic();
        resetPreview();
    }

    function resetPreview() {
        currentLine = -1;
        document.getElementById('game-scene').className = 'game-scene';
        document.getElementById('game-text').innerText = "ç‚¹å‡»å±å¹•å¼€å§‹æ¸¸æˆ";
        document.getElementById('game-name').innerText = "???";
        document.getElementById('game-name').style.background = "#333";
    }

    function nextDialogue() {
        if (isTyping) return;

        if (currentLine < data.script.length - 1) {
            currentLine++;
            const line = data.script[currentLine];
            const isPlayer = line.speaker === 'player';
            const config = isPlayer ? data.player : data.boss;

            // è®¾ç½®åå­—å’Œé¢œè‰²
            const nameTag = document.getElementById('game-name');
            nameTag.innerText = config.name;
            nameTag.style.background = config.color;

            // åˆ‡æ¢åœºæ™¯çŠ¶æ€ (è°åœ¨è¯´è¯)
            const scene = document.getElementById('game-scene');
            if (isPlayer) {
                scene.className = 'game-scene scene-left-active';
            } else {
                scene.className = 'game-scene scene-right-active';
            }

            // æ‰“å­—æœºæ•ˆæœ
            typeText(line.text);
        } else {
            resetPreview();
        }
    }

    function typeText(text) {
        const el = document.getElementById('game-text');
        el.innerText = '';
        isTyping = true;
        let i = 0;
        function loop() {
            if (i < text.length) {
                el.innerText += text.charAt(i);
                i++;
                setTimeout(loop, 40);
            } else {
                isTyping = false;
            }
        }
        loop();
    }

    function resetAll() {
        if(confirm('ç¡®å®šé‡ç½®æ‰€æœ‰è®¾ç½®å—ï¼Ÿ')) {
            data = JSON.parse(JSON.stringify(defaultData));
            loadUI();
            renderScript();
            updatePreview();
        }
    }

    // --- å¯¼å‡ºåŠŸèƒ½ ---

    function showToast(msg) {
        const toast = document.getElementById('toast');
        document.getElementById('toast-msg').innerText = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function exportGame() {
        const json = JSON.stringify(data).replace(/</g, "\\u003c").replace(/>/g, "\\u003e");
        
        const css = `
            * { box-sizing: border-box; margin: 0; padding: 0; }
            body { background: #000; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; font-family: sans-serif; }
            #game { width: 100%; height: 100%; max-width: 1000px; max-height: 800px; display: flex; flex-direction: column; background: #222; box-shadow: 0 0 50px rgba(0,0,0,0.5); position: relative; }
            .scene { flex: 1; background-size: cover; background-position: center; display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 40px; transition: 0.3s; }
            .avatar { width: 25vw; height: 60vh; background-size: cover; background-position: top center; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); }
            .avatar.left { margin-left: 50px; transform: scale(0.9) translateY(20px); opacity: 0.6; }
            .avatar.right { margin-right: 50px; transform: scale(1); opacity: 1; }
            .scene.s-left .avatar.left { transform: scale(1.1) translateY(-20px); opacity: 1; filter: brightness(1.2) drop-shadow(0 0 20px rgba(255,255,255,0.2)); z-index: 2; }
            .scene.s-left .avatar.right { transform: scale(0.9); opacity: 0.5; filter: grayscale(0.8); z-index: 1; }
            .scene.s-right .avatar.right { transform: scale(1.1) translateY(-20px); opacity: 1; filter: brightness(1.2) drop-shadow(0 0 20px rgba(255,255,255,0.2)); z-index: 2; }
            .scene.s-right .avatar.left { transform: scale(0.9); opacity: 0.5; filter: grayscale(0.8); z-index: 1; }
            .dialogue-box { height: 25vh; background: rgba(0,0,0,0.9); border: 3px solid #fff; border-radius: 12px; margin: 20px; padding: 25px; display: flex; flex-direction: column; position: relative; backdrop-filter: blur(5px); }
            .name-tag { position: absolute; top: -20px; left: 30px; padding: 8px 24px; border-radius: 30px; border: 3px solid #fff; font-weight: bold; font-size: 1.2rem; color: #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: background 0.3s; }
            .text { margin-top: 15px; font-size: 1.2rem; color: #fff; white-space: pre-wrap; line-height: 1.6; }
            .next { position: absolute; bottom: 15px; right: 20px; animation: bounce 1s infinite; }
            @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(5px); } }
            @media (max-width: 600px) { .avatar { width: 40vw; } .dialogue-box { margin: 10px; height: 30vh; } }
        `;

        const js = `
            const d = JSON.parse("${json}");
            let idx = -1, typing = false;
            const scene = document.getElementById('scene');
            const avL = document.getElementById('avL');
            const avR = document.getElementById('avR');
            const name = document.getElementById('name');
            const txt = document.getElementById('txt');
            const game = document.getElementById('game');

            // è®¾ç½®åˆå§‹èµ„æº
            scene.style.backgroundImage = 'url(' + d.bg + ')';
            avL.style.backgroundImage = 'url(' + d.player.img + ')';
            avR.style.backgroundImage = 'url(' + d.boss.img + ')';

            // åº”ç”¨å½¢çŠ¶æ ·å¼
            function applyAvatar(el, c) {
                if(c.shape==='circle') el.style.borderRadius='50%';
                if(c.shape==='rounded') el.style.borderRadius='30px';
                if(c.shape==='square') el.style.borderRadius='0';
                el.style.boxShadow='none'; el.style.border='none';
                if(c.borderStyle==='solid') el.style.border='6px solid '+c.color;
                if(c.borderStyle==='glow') { el.style.boxShadow='0 0 30px '+c.color; el.style.border='2px solid '+c.color; }
            }
            applyAvatar(avL, d.player);
            applyAvatar(avR, d.boss);

            game.onclick = function(){
                if(typing) return;
                if(idx < d.script.length - 1){
                    idx++;
                    const l = d.script[idx];
                    const isP = l.speaker === 'player';
                    const cfg = isP ? d.player : d.boss;
                    
                    name.innerText = cfg.name;
                    name.style.background = cfg.color;
                    
                    if(isP) scene.className = 'scene s-left';
                    else scene.className = 'scene s-right';

                    type(l.text);
                } else {
                    idx = -1;
                    txt.innerText = "ç‚¹å‡»é‡æ’­";
                    scene.className = 'scene';
                    name.style.background = '#333';
                    name.innerText = '???';
                }
            };
            function type(str){
                txt.innerText=''; typing=true;
                let i=0;
                function t(){
                    if(i<str.length){ txt.innerText+=str.charAt(i); i++; setTimeout(t,40); }
                    else typing=false;
                }
                t();
            }
        `;

        const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>RPG Game</title><style>${css}</style></head><body><div id="game"><div class="scene" id="scene"><div class="avatar left" id="avL"></div><div class="avatar right" id="avR"></div></div><div class="dialogue-box"><div class="name-tag" id="name">???</div><div class="text" id="txt">ç‚¹å‡»å±å¹•å¼€å§‹</div><div class="next">â–¼</div></div></div><script>${js}<\/script></body></html>`;

        const blob = new Blob([html], {type: 'text/html'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `rpg-game-${Date.now()}.html`;
        a.click();
        showToast("æ¸¸æˆå¯¼å‡ºæˆåŠŸï¼");
    }

    // å¯åŠ¨
    init();

</script>
</body>
</html>
